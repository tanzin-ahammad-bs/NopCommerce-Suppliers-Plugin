@using Nop.Plugin.Misc.PurchaseOrder.Areas.Admin.Models
@model List<AddProductPopupModel>

@{
    Layout = "_AdminPopupLayout"; // Uses the nopCommerce standard popup layout
    ViewBag.PageTitle = T("Admin.Catalog.Products.RelatedProducts.AddNew").Text;
}

<form asp-controller="PurchaseOrder" asp-action="AddProductPopup"
      asp-route-supplierId="@ViewBag.SupplierId"
      id="saveSelectedProductsForm">
    <div class="content-header clearfix">
        <h1 class="float-left">
            @T("Admin.Catalog.Products.RelatedProducts.AddNew")
        </h1>
    </div>
    <section class="content">
        <div class="container-fluid">
            <div class="form-horizontal">
                <div class="card card-default card-popup">
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-bordered">
                                <thead>
                                    <tr>
                                        <th><input type="checkbox" id="selectAll" /></th>
                                        <th>@T("Admin.Catalog.Products.Fields.Name").Text</th>
                                        <th>@T("Admin.Catalog.Products.Fields.Published").Text</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var product in Model)
                                    {
                                        <tr>
                                            <td>
                                                <input type="checkbox" name="selectedProducts" value="@product.ProductId" />
                                            </td>
                                            <td>@product.ProductName</td>
                                            <td>@(product.Published ? T("Admin.Common.Yes").Text : T("Admin.Common.No").Text)</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="card-footer">
                        <button type="button" class="btn btn-primary" id="saveSelectedProductsBtn">
                            <i class="far fa-floppy-disk"></i> @T("Admin.Common.Save")
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </section>
</form>

<script>
    $(document).ready(function () {
        $('#selectAll').click(function () {
            $('input[name="selectedProducts"]').prop('checked', this.checked);
        });

        $('#saveSelectedProductsBtn').click(function () {
            var selectedProductIds = [];
            $('input[name="selectedProducts"]:checked').each(function () {
                selectedProductIds.push(parseInt($(this).val()));
            });

            if (selectedProductIds.length === 0) {
                window.close();
                return;
            }

            var supplierId = parseInt('@ViewBag.SupplierId');

            $.ajax({
                type: "POST",
                url: '@Url.Action("SaveSelectedProductsFromPopup", "PurchaseOrder")',
                data: JSON.stringify({
                    supplierId: supplierId,
                    selectedProductIds: selectedProductIds
                }),
                contentType: "application/json; charset=utf-8",
                success: function (response) {
                    if (response.success) {
                        if (window.opener && !window.opener.closed) {
                            window.opener.location.reload();
                        }
                        window.close();
                    } else {
                        alert(response.message || "Unexpected error.");
                    }
                },
                error: function () {
                    alert('Error while saving products.');
                }
            });
        });
    });
</script>

<style>
    .modal-dialog {
        margin-top: 15vh;
        margin-left: auto;
        margin-right: auto;
        width: 80%;
        max-width: 900px;
    }

    .modal-content {
        max-height: 80vh;
        overflow-y: auto;
    }

    .table-responsive {
        margin-bottom: 15px;
    }

    .table {
        width: 100%;
        margin-bottom: 1rem;
        color: #212529;
    }

    th, td {
        padding: 0.75rem;
        vertical-align: top;
        border-top: 1px solid #dee2e6;
    }

    th {
        text-align: left;
    }
</style>
